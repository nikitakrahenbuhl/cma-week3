---
title: "Exercse 3"
output: html_notebook
---

# Task 1: Segmentation

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggpubr)

theme_set(
  theme_classic()
)
```
Import data
```{r}
caro <- read_csv("0_rawdata/caro60.csv")
caro_original <- caro
```
Our sampling interval is 1 minute - if we take a temporal window of 6 minutes we use a window size of 6 positions. Therefore that's 3 plus and 3 minus.

```{r}
caro %>% 
  mutate(
    nMinus3 = sqrt((lag(E,3)-E)^2 + (lag(N,3)-N)^2),
    nMinus2 = sqrt((lag(E,2)-E)^2+(lag(N,2)-N)^2),  
    nMinus1 = sqrt((lag(E,1)-E)^2+(lag(N,1)-N)^2),
    nPlus1  = sqrt((E-lead(E,1))^2+(N-lead(N,1))^2), 
    nPlus2  = sqrt((E-lead(E,2))^2+(N-lead(N,2))^2),  
    nPlus3  = sqrt((E-lead(E,3))^2+(N-lead(N,3))^2)  
) -> caro

caro %>% 
  rowwise() %>% 
  mutate(
    stepMean = mean(c(nMinus3, nMinus2, nMinus1, nPlus1, nPlus2, nPlus3))
  ) %>% 
  ungroup() -> caro
```


# Task 2: Specify and apply threshold *d*
Lets explore with histogram
```{r}
ggplot(caro) +
  geom_boxplot(aes(y = stepMean), outlier.shape = NA)  +
  scale_y_continuous(limits = c(0, 20))

ggplot(caro) +
  geom_histogram(aes(stepMean), bins = 60) 

summary(caro$stepMean)

ggplot(caro) +
  geom_line(aes(x=DatetimeUTC, y=stepMean)) +
  geom_hline(yintercept = 4, color = "red")
```
Based on the observations I would pick d =< 4

Remove static points
```{r}
caro %>% 
  ungroup() %>% 
  mutate(static = stepMean < mean(stepMean, na.rm = TRUE)) -> caro

caro %>% 
  filter(!static) -> caro_filtered
  ggplot(data = caro_filtered, aes(x = E, y = N)) +
    geom_path() +
    geom_point() +
    coord_fixed()
```
# Task 3 Visualise segmented trajectories
```{r}
ggplot(caro, aes(E, N)) +
  geom_path() +
  geom_point(aes(color = static)) +
  coord_equal()
```
# Task 4: Segment based analysis
Functions to create unique IDs
```{r}
rle_id <- function(vec){
  x <- rle(vec)$lengths
  as.factor(rep(seq_along(x), times=x))
  }
```

Assign unique IDs to Caro
```{r}
caro <- caro %>%
  mutate(segment_id = rle_id(static))

caro
```
```{r}
caro %>% 
  mutate(timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = "mins"))) %>%
  group_by(segment_id) %>% 
  summarise(total_time = sum(timelag)) -> segment_duration

left_join(caro, segment_duration, by = "segment_id") -> caro
```


Makes plots
```{r}
caro %>% 
  filter(!static) %>% 
  filter(total_time >= 5) %>% 
  ggplot(., aes(E, N, color = segment_id)) +
  geom_path() +
  geom_point() +
  coord_equal() + labs(title="Removed segments shorter than 5 minutes")
```
# Task 5

